<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chest IMU Web — Spine Tasks</title>
<style>
  :root{
    --accent:#007aff; /* iOS system blue */
    --bg:#ffffff;
    --text:#111111;
    --sub:#555555;
    --shadow:0 10px 30px rgba(0,0,0,.08);
    --radius:18px;
  }
  html,body{height:100%}
  body{
    margin:0;
    font-family: -apple-system, system-ui, "SF Pro Text", "SF Pro Display", Segoe UI, Roboto, Arial, sans-serif;
    background:var(--bg);
    color:var(--text);
    -webkit-font-smoothing:antialiased;
  }
  /* iOS large title header */
  .header{
    position:sticky; top:0; z-index:5;
    background:linear-gradient(#f8f8f8,#fff);
    padding:20px 16px 10px;
    border-bottom:1px solid #eee;
  }
  .large-title{
    font-size:34px; font-weight:700; letter-spacing:.2px;
    text-align:center;
  }

  /* centered card */
  .wrap{
    max-width:740px; margin:18px auto; padding:0 16px;
  }
  .card{
    background:#fff; border-radius:var(--radius); box-shadow:var(--shadow);
    padding:22px 18px;
  }

  /* layout blocks */
  .center{ text-align:center; }
  .vspace{ margin-top:14px; }
  .hint{ color:var(--sub); font-size:14px; line-height:1.35; }
  .status{ font-weight:700; font-size:18px; margin-top:10px; }
  .pill{ padding:4px 10px; border-radius:999px; background:#f2f2f7; display:inline-block; font-size:13px; }

  /* Task selector (iOS look) */
  .selector{
    appearance:none;
    font-size:22px; font-weight:600;
    padding:10px 16px; min-width:320px; max-width:100%;
    border:1px solid #e5e5ea; border-radius:12px;
    background:#fff url("data:image/svg+xml,%3Csvg viewBox='0 0 16 10' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M2 2l6 6 6-6' stroke='%23999' stroke-width='2' fill='none' stroke-linecap='round'/%3E%3C/svg%3E") no-repeat right 12px center/16px 10px;
  }

  /* iOS-like buttons */
  .btn{
    font-size:17px; font-weight:600; padding:12px 18px; min-width:170px;
    border-radius:12px; border:1px solid transparent; cursor:pointer;
    transition:.15s transform ease, .2s background ease;
    display:inline-block;
  }
  .btn:active{ transform:scale(.98) }
  .btn-primary{ background:var(--accent); color:#fff; }
  .btn-secondary{ background:#f2f2f7; color:#111; border-color:#e5e5ea; }
  .btn[disabled]{ opacity:.5; cursor:default; transform:none }

  /* grid of buttons */
  .btns{ display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }

  /* footer info */
  footer{ color:#8e8e93; font-size:12px; text-align:center; padding:16px 0 28px; }
</style>
</head>
<body>
  <div class="header">
    <div class="large-title">Spine Motion (Web)</div>
  </div>

  <div class="wrap">
    <div class="card center">
      <!-- Task -->
      <div class="vspace">
        <label for="task" class="hint" style="display:block;margin-bottom:6px;">Task</label>
        <select id="task" class="selector">
          <option>Slow Lateral Range</option>
          <option>Slow Axial Range</option>
          <option>Slow Sagittal Range</option>
          <option>Fast Lateral Continuous</option>
          <option>Fast Axial Continuous</option>
          <option>Fast Sagittal Continuous</option>
          <option>Fast Sagittal (Twist Right)</option>
          <option>Fast Sagittal (Twist Left)</option>
        </select>
      </div>

      <!-- Buttons -->
      <div class="btns vspace">
        <button id="btnStart" class="btn btn-primary">Request Permission & Start</button>
        <button id="btnStop" class="btn btn-secondary" disabled>Stop</button>
        <button id="btnSave" class="btn btn-secondary" disabled>Save CSV</button>
      </div>

      <!-- Status + hint -->
      <div id="status" class="status vspace">Idle</div>
      <div id="hint" class="hint vspace">Place phone at mid-chest, screen facing forward. Keep it steady.</div>
      <div class="vspace"><span class="pill" id="cycles">Cycles: 0/6</span></div>
    </div>

    <footer class="wrap">
      Sampling uses DeviceMotion &amp; DeviceOrientation (~60 Hz). Data stays on your device.
    </footer>
  </div>

<script>
(() => {
  // -------------------- Constants --------------------
  const TWO_PI = Math.PI * 2;
  const DEG = Math.PI / 180.0;  // deg -> rad
  const BAND   = 6  * DEG;      // near-center band (~6°)
  const THRESH = 12 * DEG;      // beyond threshold (~12°)
  const TWIST  = 15 * DEG;      // twist lock (~15°)
  const STILL_GYRO = 0.07;      // rad/s magnitude
  const STILL_WINDOW = 1000;    // ms
  const TARGET_TRIPS = 6;

  // -------------------- Session State --------------------
  let phase = 'idle'; // idle -> waitingStill -> running -> done
  let neutral = { yaw:0, pitch:0, roll:0 };
  let t0 = null;
  let stillSince = null;

  // detector runtime
  let lastOut=false, trips=0, state=0, locked=false, lockStart=null, firstSideSign=null;

  // latest readings
  let last = {
    ts: 0,
    ax: 0, ay: 0, az: 0,          // from DeviceMotion (browser单位视实现而定，原样记录)
    gx: 0, gy: 0, gz: 0,          // rad/s (由 deg/s 转换)
    alpha: 0, beta: 0, gamma: 0,  // 原始欧拉（deg）
    yaw: 0, pitch: 0, roll: 0     // 推导的 yaw/pitch/roll（rad）
  };

  // samples buffer
  let samples = [];

  // -------------------- UI handles --------------------
  const $task   = document.getElementById('task');
  const $start  = document.getElementById('btnStart');
  const $stop   = document.getElementById('btnStop');
  const $save   = document.getElementById('btnSave');
  const $status = document.getElementById('status');
  const $hint   = document.getElementById('hint');
  const $cycles = document.getElementById('cycles');

  const setStatus = (s)=> $status.textContent = s;
  const setHint   = (s)=> $hint.textContent   = s;
  const setCycles = (c)=> $cycles.textContent = `Cycles: ${c}/${TARGET_TRIPS}`;

  function resetDetector(){
    lastOut=false; trips=0; state=0; locked=false; lockStart=null; firstSideSign=null;
    setCycles(0);
  }

  function start(){
    samples.length = 0;
    resetDetector();
    phase = 'waitingStill';
    setStatus('Waiting for stillness…');
    setHint(startHint($task.value));
    t0 = performance.now();
    stillSince = null;

    $start.disabled = true;
    $stop.disabled  = false;
    $save.disabled  = true;
  }

  function stop(){
    phase = 'idle';
    setStatus('Idle');
    $start.disabled = false;
    $stop.disabled  = true;
    $save.disabled  = samples.length === 0;
  }

  // -------------------- Permission flow --------------------
  async function requestAndStart(){
    try {
      // iOS Safari 需要手势 + 显式授权
      if (typeof DeviceMotionEvent !== 'undefined' &&
          typeof DeviceMotionEvent.requestPermission === 'function') {
        const r1 = await DeviceMotionEvent.requestPermission();
        if (r1 !== 'granted') { alert('Motion permission denied. 在 设置→Safari 打开 Motion & Orientation Access。'); return; }
      }
      if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        const r2 = await DeviceOrientationEvent.requestPermission();
        if (r2 !== 'granted') { alert('Orientation permission denied. 在 设置→Safari 打开 Motion & Orientation Access。'); return; }
      }
      start();
    } catch (e) {
      console.error(e);
      alert('Permission error: ' + e.message);
    }
  }

  // -------------------- Sensors --------------------
  window.addEventListener('devicemotion', (e) => {
    const now = performance.now();
    // 优先 accelerationIncludingGravity；不同设备实现不一，这里按原样记录（分析时自处理重力项）
    const a = e.accelerationIncludingGravity || e.acceleration;
    if (a){ last.ax = a.x || 0; last.ay = a.y || 0; last.az = a.z || 0; }

    // rotationRate: alpha(Z)/beta(X)/gamma(Y)，单位 deg/s
    if (e.rotationRate){
      last.gz = (e.rotationRate.alpha || 0) * DEG;  // -> rad/s
      last.gx = (e.rotationRate.beta  || 0) * DEG;
      last.gy = (e.rotationRate.gamma || 0) * DEG;
    }
    last.ts = now;
    step(now);
  });

  window.addEventListener('deviceorientation', (e) => {
    last.alpha = e.alpha ?? 0;
    last.beta  = e.beta  ?? 0;
    last.gamma = e.gamma ?? 0;
    // 近似映射：yaw≈alpha(z)、pitch≈beta(x)、roll≈gamma(y)
    last.yaw   = (last.alpha || 0) * DEG;
    last.pitch = (last.beta  || 0) * DEG;
    last.roll  = (last.gamma || 0) * DEG;
  });

  // -------------------- Logic --------------------
  const isStill = ()=> Math.hypot(last.gx,last.gy,last.gz) < STILL_GYRO;

  function relAngles(){
    return {
      yaw:   wrap(last.yaw   - neutral.yaw),
      pitch: wrap(last.pitch - neutral.pitch),
      roll:  wrap(last.roll  - neutral.roll),
    };
  }
  function wrap(x){ while(x>Math.PI) x-=TWO_PI; while(x<-Math.PI) x+=TWO_PI; return x; }

  function step(now){
    if (phase === 'waitingStill'){
      if (isStill()){
        if (!stillSince) stillSince = now;
        if (now - stillSince >= STILL_WINDOW){
          neutral = { yaw:last.yaw, pitch:last.pitch, roll:last.roll };
          phase = 'running';
          setStatus('Recording…');
          setHint(runningHint($task.value));
          t0 = now;
        }
      } else {
        stillSince = null;
      }
      return;
    }

    if (phase !== 'running') return;

    const t = (now - t0) / 1000.0;
    const rel = relAngles();

    // 记录一帧
    samples.push({
      t,
      yaw: rel.yaw, pitch: rel.pitch, roll: rel.roll,
      ax: last.ax, ay: last.ay, az: last.az,
      gx: last.gx, gy: last.gy, gz: last.gz,
      alpha: last.alpha, beta: last.beta, gamma: last.gamma
    });

    // 任务状态机
    let finished = false;
    const task = $task.value;

    if (task === 'Slow Lateral Range') {
      finished = slowSequenceDone(rel.roll);
    } else if (task === 'Slow Axial Range') {
      finished = slowSequenceDone(rel.yaw);
    } else if (task === 'Slow Sagittal Range') {
      finished = slowSagittalDone(rel.pitch);
    } else if (task === 'Fast Lateral Continuous') {
      const r = cycle(rel.roll); finished = r.done; setCycles(r.trips);
    } else if (task === 'Fast Axial Continuous') {
      const r = cycle(rel.yaw);  finished = r.done; setCycles(r.trips);
    } else if (task === 'Fast Sagittal Continuous') {
      const r = cycle(rel.pitch); finished = r.done; setCycles(r.trips);
    } else if (task === 'Fast Sagittal (Twist Right)') {
      const r = twistThenCycles(rel.yaw, rel.pitch, +1);
      finished = r.done; setCycles(r.trips);
      setHint(r.locked ? 'Locked right: fast crunch ×6' : 'Twist RIGHT ≥15° & hold 1s');
    } else if (task === 'Fast Sagittal (Twist Left)') {
      const r = twistThenCycles(rel.yaw, rel.pitch, -1);
      finished = r.done; setCycles(r.trips);
      setHint(r.locked ? 'Locked left: fast crunch ×6' : 'Twist LEFT ≥15° & hold 1s');
    }

    if (finished){
      phase = 'done';
      setStatus('Done');
      setHint('Finished. Tap “Save CSV”.');
      $save.disabled = false;
      $stop.disabled = true;
    }
  }

  // ---- detectors ----
  function slowSequenceDone(x){
    // 任一侧 → 回中 → 另一侧 → 回中
    switch (state){
      case 0:
        if (Math.abs(x) > THRESH){ firstSideSign = x>0 ? +1 : -1; state = 1; }
        break;
      case 1:
        if (Math.abs(x) < BAND){ state = 2; }
        break;
      case 2:
        if (firstSideSign && ((firstSideSign>0 && x < -THRESH) || (firstSideSign<0 && x > THRESH))){ state = 3; }
        break;
      case 3:
        if (Math.abs(x) < BAND){ return true; }
        break;
    }
    return false;
  }
  function slowSagittalDone(p){
    switch (state){
      case 0: if (p > THRESH){ state = 1; } break;
      case 1: if (Math.abs(p) < BAND){ return true; }
    }
    return false;
  }
  function cycle(x){
    if (!lastOut){
      if (Math.abs(x) > THRESH) lastOut = true;
    } else {
      if (Math.abs(x) < BAND){ lastOut = false; trips += 1; }
    }
    return { trips, done: trips >= TARGET_TRIPS };
  }
  function twistThenCycles(yaw, pitch, dir){
    if (!locked){
      const ok = dir>0 ? (yaw > TWIST) : (yaw < -TWIST);
      if (ok){
        if (!lockStart) lockStart = performance.now();
        if (performance.now() - lockStart >= 1000){
          locked = true; lastOut = false; trips = 0;
        }
      } else lockStart = null;
      return { locked:false, trips, done:false };
    } else {
      const r = cycle(pitch);
      return { locked:true, trips:r.trips, done:r.done };
    }
  }

  // -------------------- Save / Share CSV --------------------
  async function saveCSV(){
    if (!samples.length) return;
    let s = 't,yaw,pitch,roll,ax,ay,az,gx,gy,gz,alpha,beta,gamma\n';
    for (const v of samples){
      s += `${v.t.toFixed(6)},${v.yaw},${v.pitch},${v.roll},${v.ax},${v.ay},${v.az},${v.gx},${v.gy},${v.gz},${v.alpha},${v.beta},${v.gamma}\n`;
    }
    const filename = `ChestIMU_${Date.now()}.csv`;
    const blob = new Blob([s], {type:'text/csv'});
    const file = new File([blob], filename, {type:'text/csv'});

    // 优先调用 iOS/Android 的系统分享（可 AirDrop）
    if (navigator.canShare && navigator.canShare({ files:[file] }) && navigator.share){
      try{
        await navigator.share({
          files:[file],
          title:'Chest IMU CSV',
          text:'Spine motion session data'
        });
        return; // 分享成功则结束
      }catch(err){
        // 用户取消或不支持，继续走下载
        console.warn('Share error or canceled:', err);
      }
    }
    // 回退：触发下载
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a); a.click();
    URL.revokeObjectURL(url); a.remove();
  }

  // -------------------- Hints --------------------
  function startHint(task){
    switch (task){
      case 'Slow Lateral Range': return 'Stand still (1s). Then: side → center → other side → center.';
      case 'Slow Axial Range'  : return 'Stand still (1s). Then: twist side → center → other side → center.';
      case 'Slow Sagittal Range':return 'Stand still (1s). Then: crunch forward → back to center.';
      case 'Fast Lateral Continuous' : return 'Stand still (1s). Then: fast lateral ×6.';
      case 'Fast Axial Continuous'   : return 'Stand still (1s). Then: fast axial twist ×6.';
      case 'Fast Sagittal Continuous': return 'Stand still (1s). Then: fast crunch ×6.';
      case 'Fast Sagittal (Twist Right)': return 'Stand still (1s). Then: twist RIGHT ≥15° & hold 1s → fast crunch ×6.';
      case 'Fast Sagittal (Twist Left)' : return 'Stand still (1s). Then: twist LEFT ≥15° & hold 1s → fast crunch ×6.';
    }
    return '';
  }
  function runningHint(task){
    switch (task){
      case 'Slow Lateral Range'     : return 'Go: side → center → other side → center.';
      case 'Slow Axial Range'       : return 'Go: side twist → center → other side → center.';
      case 'Slow Sagittal Range'    : return 'Go: crunch forward → back to center.';
      case 'Fast Lateral Continuous': return 'Go fast: lateral ×6.';
      case 'Fast Axial Continuous'  : return 'Go fast: axial twist ×6.';
      case 'Fast Sagittal Continuous':return 'Go fast: crunch ×6.';
      case 'Fast Sagittal (Twist Right)': return 'Twist RIGHT & hold 1s to lock, then fast crunch ×6.';
      case 'Fast Sagittal (Twist Left)' : return 'Twist LEFT & hold 1s to lock, then fast crunch ×6.';
    }
    return '';
  }

  // -------------------- Bind UI --------------------
  document.getElementById('btnStart').addEventListener('click', requestAndStart);
  document.getElementById('btnStop' ).addEventListener('click', stop);
  document.getElementById('btnSave' ).addEventListener('click', saveCSV);
})();
</script>
</body>
</html>
